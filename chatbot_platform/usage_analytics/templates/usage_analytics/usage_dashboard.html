{# usage_tracking/templates/usage_tracking/usage_dashboard.html #}
{% extends 'webapp/base.html' %} {# Extend your main base template #}
{% load static %}

{% block title %}Usage Dashboard | {{ block.super }}{% endblock title %}

{% block extra_head %}
    {# Link directly to the main dashboard.css for consistent styling #}
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    {# No need for usage_dashboard.css now if dashboard.css covers it #}
{% endblock extra_head %}

{% block content %}
    <header>
        <h1>Usage Dashboard</h1>
        <div class="header-right">
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">Main Dashboard</a>
            <a href="{% url 'logout' %}" class="btn btn-logout">Logout</a>
        </div>
    </header>

    <div class="message-container">
        {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                    <li class="message {{ message.tags }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>

    <main>
        <h2>Your Chatbot Usage Statistics</h2>

        {% if knowledge_bases %}
            {# Reusing knowledge-base-list to apply dashboard.css styling #}
            <ul class="knowledge-base-list"> 
                {% for kb in knowledge_bases %}
                    {# Reusing knowledge-base-item to apply dashboard.css styling #}
                    <li class="knowledge-base-item">
                        <p><strong>Title:</strong> {{ kb.title }}</p>
                        <p><strong>Owned By:</strong> {{ kb.user.username }}</p>
                        <p><strong>Created On:</strong> {{ kb.created_at|date:"F d, Y, P" }}</p>
                        
                        {# Display Usage Stats (using related_name 'usage_stats') #}
                        {% if kb.usage_stats %} 
                            <p class="card-text"><strong>Total Messages:</strong> {{ kb.usage_stats.total_messages_sent }}</p>
                            {% if kb.usage_stats.last_message_at %}
                                <p class="card-text"><strong>Last Message:</strong> {{ kb.usage_stats.last_message_at|date:"F d, Y, P H:i" }}</p>
                            {% else %}
                                <p class="card-text"><strong>Last Message:</strong> Never</p>
                            {% endif %}
                            <p class="card-text"><small>Updated: {{ kb.usage_stats.updated_at|date:"F d, Y, P H:i" }}</small></p>
                        {% else %}
                            <p class="card-text no-usage-data">No usage data yet for this chatbot. Start chatting!</p>
                        {% endif %}
                        
                        {# Link to test the chatbot (only if it's embedded) #}
                        {# is_embedded is a field on KnowledgeBase that should exist on fix-deploy-dev #}
                        {% if kb.is_embedded %}
                            <div class="buttons"> {# Reuse 'buttons' class #}
                                <a href="{% url 'chat_widget' kb.widget_slug %}" class="btn btn-test" target="_blank">Test Chatbot</a>
                            </div>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="no-kbs-message">
                <p>You don't have any Knowledge Bases uploaded yet.</p>
                <p>Upload your first one from the <a href="{% url 'upload' %}">main dashboard</a> to start tracking usage!</p>
            </div>
        {% endif %}
    </main>

    <footer>
        &copy; {{ year|default:2025 }} CAPI Studio. All rights reserved.
    </footer>
{% endblock content %}

{# No specific JS for usage_dashboard needed yet, as it's static display #}
{% block extra_js %}
    {# <script src="{% static 'usage_tracking/js/usage_dashboard.js' %}"></script> #}
{% endblock extra_js %}